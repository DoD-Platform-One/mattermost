domain: bigbang.dev

istio:
  # -- Toggle istio integration
  enabled: false
  # -- Istio sidecar injection mode (enabled, disabled, or empty for no label)
  injection: disabled

  # -- Mutual TLS configuration
  mtls:
    # -- STRICT = Allow only mutual TLS traffic,
    # PERMISSIVE = Allow both plain text and mutual TLS traffic
    mode: STRICT

  # -- Sidecar configuration for Istio
  sidecar:
    # -- Enable/disable Istio Sidecar resource (restricts outbound traffic)
    enabled: true
    # -- Outbound traffic policy mode (REGISTRY_ONLY or ALLOW_ANY)
    outboundTrafficPolicyMode: REGISTRY_ONLY

  # -- Service Entries Configuration
  serviceEntries:
    # -- List of custom Istio ServiceEntry resources
    custom: []

  # -- Authorization Policies Configuration
  authorizationPolicies:
    # -- Enable/disable the generation of Istio AuthorizationPolicies
    enabled: true
    # -- Generate AuthorizationPolicies from NetworkPolicy configurations
    generateFromNetpol: true
    # -- Custom authorization policies - additional policies added via additionalPolicies
    custom: []

    # -- Additional authorization policies (map format)
    additionalPolicies: {}

# -- Routes configuration for bb-common
routes:
  # -- Inbound routes (creates VirtualService, ServiceEntry, NetworkPolicy, AuthorizationPolicy)
  inbound:
    chat:
      enabled: true
      gateways:
        - istio-gateway/public-ingressgateway
      hosts:
        - chat.{{ .Values.domain }}
      service: '{{ .Release.Name }}'
      port: 8065
      selector:
        app: mattermost
  # -- Outbound routes (creates ServiceEntry for egress traffic)
  outbound:
    # -- Mattermost external services (update checks, notices, integrations, analytics)
    mattermost-external:
      enabled: true
      hosts:
        - securityupdatecheck.mattermost.com
        - customers.mattermost.com
        - notices.mattermost.com
        - api.integrations.mattermost.com
        - pdat.matterlytics.com
        - api.github.com
      ports:
        - number: 443
          name: https
          protocol: TLS
    # -- SSO provider service entry (enables SSO authentication in REGISTRY_ONLY mode)
    sso:
      enabled: false
      hosts:
        - '{{ include "sso.host" . }}'
      ports:
        - number: 443
          name: https
          protocol: TLS

# -- Specification to configure an Ingress with Mattermost
ingress:
  enabled: false
  host: ""
  annotations: {}
  tlsSecret: ""

# NOTE: Requires enterprise.enabled to have any effect
monitoring:
  enabled: false
  namespace: monitoring

  serviceMonitor:
    scheme: http
    tlsConfig: {}

networkPolicies:
  enabled: false
  ingress:
    to:
      # -- Mattermost metrics ingress from monitoring
      mattermost:8067:
        from:
          k8s:
            monitoring/prometheus: true
      # -- Minio ingress from minio-operator
      minio:9000:
        podSelector:
          matchLabels:
            app: minio
        from:
          k8s:
            minio-operator/*: true
      # -- Minio metrics ingress from monitoring
      minio-metrics:
        podSelector:
          matchLabels:
            app: minio
            v1.min.io/tenant: mattermost-minio
        from:
          k8s:
            monitoring/prometheus: true

  egress:
    definitions:
      # -- Storage subnets for S3-compatible storage (override in Big Bang)
      storage-subnets:
        to:
          - ipBlock:
              cidr: 0.0.0.0/0
              except:
                - 169.254.169.254/32
    from:
      # -- Mattermost app egress (external integrations, updates, elasticsearch, etc.)
      mattermost:
        to:
          k8s:
            logging/elasticsearch:9200:
              podSelector:
                matchLabels:
                  common.k8s.elastic.co/type: elasticsearch
      # -- Wait job egress to kubeAPI
      wait-job:
        podSelector:
          matchLabels:
            job-name: mattermost-wait-job
        to:
          definition:
            kubeAPI: true
      # -- Minio egress to minio-operator and storage
      minio:
        to:
          k8s:
            minio-operator/minio-operator:4222: true
          # -- Minio egress to storage subnets (for external S3-compatible storage)
          definition:
            storage-subnets: true
            kubeAPI: true
      # -- Update check job egress
      update-check:
        podSelector:
          matchLabels:
            app: mattermost-update-check
        to:
          cidr:
            0.0.0.0/0: true
      # -- Tempo egress (when istio injection is enabled)
      tempo:
        to:
          k8s:
            tempo/tempo:9411: true

  additionalPolicies: []

sso:
  enabled: false
  client_id: platform1_a8604cc9-f5e9-4656-802d-d05624370245_bb8-mattermost
  # Change to your client secret
  client_secret: nothing
  # Change to your respective IDP endpoints 
  auth_endpoint: https://login.dso.mil/auth/realms/baby-yoda/protocol/openid-connect/auth
  token_endpoint: https://login.dso.mil/auth/realms/baby-yoda/protocol/openid-connect/token
  user_api_endpoint: https://login.dso.mil/auth/realms/baby-yoda/protocol/openid-connect/userinfo
  enable_sign_up_with_email: false
  enable_sign_in_with_email: false
  enable_sign_in_with_username: false

# Repo and image tag
image:
  name: registry1.dso.mil/ironbank/opensource/mattermost/mattermost
  tag: 11.4.0
  imagePullPolicy: IfNotPresent

global:
  imagePullSecrets:
  - name: private-registry

# Mattermost instance desired replicas
replicaCount: 1

users: null # Allowable: 100, 1000, 5000, 10000, 25000

enterprise:
  enabled: false
  license: ""
  # Example:
  # license: |
  #   LICENSE HERE

nameOverride: ""

updateJob:
  # -- Must be disabled when Istio injected
  disabled: true
  labels: {}
  annotations: {}

resources:
  limits:
    cpu: 2
    memory: 4Gi
  requests:
    cpu: 2
    memory: 4Gi

affinity: {}
  # podAntiAffinity:
  #   requiredDuringSchedulingIgnoredDuringExecution:
  #     - topologyKey: "kubernetes.io/hostname"
  #       labelSelector:
  #         matchLabels:
  #           dont-schedule-with: mattermost
  # nodeAffinity:
  #   requiredDuringSchedulingIgnoredDuringExecution:
  #     nodeSelectorTerms:
  #     - matchExpressions:
  #       - key: node-type
  #         operator: In
  #         values:
  #         - "mattermost"

nodeSelector: {}
  # node-type: mattermost

tolerations: {}
# - key: "key1"
#   operator: "Equal"
#   value: "value1"
#   effect: "NoSchedule"

# Any ENVs provided here get put into a `mattermost-envs` secret and pulled into the env
mattermostEnvs: {}
  # MM_ENV_NAME: "{{ .Values.users }}"
  # ANOTHER_ENV_NAME: "anothervalue"

# Use this to point to pull in ENV values from existing secrets
existingSecretEnvs: {}
  # - name: MM_SQLSETTINGS_DATASOURCEREPLICAS
  #   valueFrom:
  #     secretKeyRef:
  #       key: READER_DB_CONNECTION_STRING
  #       name: '{{ .Values.database.secret | default (printf "%s-dbcreds" (include "mattermost.fullname" .)) }}'
  # - name: MM_ANOTHER_VAR
  #   valueFrom:
  #     secretKeyRef:
  #       key: DB_CONNECTION_CHECK_URL
  #       name: "mysecretname"

volumes: {}
  # - name: ca-cert
  #   secret:
  #     secretName: ca-secret
  #     defaultMode: 0644

volumeMounts: {}
  # - name: ca-cert
  #   mountPath: /etc/ssl/certs
  #   readOnly: true

# -- Pod labels for Mattermost server pods
podLabels: {}

# -- Pod annotations for Mattermost server pods
podAnnotations: {}

# -- securityContext for Mattermost server pods
securityContext:
  runAsNonRoot: true
  runAsUser: 2000
  runAsGroup: 2000
# -- containerSecurityContext for Mattermost server containers
containerSecurityContext:
  runAsNonRoot: true
  runAsUser: 2000
  runAsGroup: 2000
  capabilities:
    drop:
      - ALL

minio:
  install: false
  bucketCreationImage: "registry1.dso.mil/ironbank/opensource/minio/mc:RELEASE.2025-08-13T08-35-41Z"
  # Override the minio service name for easier connection setup
  service:
    nameOverride: "minio.mattermost.svc.cluster.local"
  upstream:
    tenant:
      name: mattermost-minio
      pools:
        - name: pool-0
          labels:
            app: minio
            app.kubernetes.io/name: minio
      configSecret:
        name: "minio-creds-secret"
        accessKey: "minio"
        secretKey: "minio123" # default key, change this!
      metrics:
        enabled: false
        port: 9000
      buckets:
        - name: mattermost
  waitJob:
    enabled: false

postgresql:
  install: false

  image:
    registry: "registry1.dso.mil/ironbank"
    repository: "opensource/postgres/postgresql"
    tag: "17.6"

    pullSecrets:
    - private-registry
  auth:
    username: "mattermost"
    password: "bigbang"
    database: "mattermost"

  fullnameOverride: "mattermost-postgresql" # Overrides the name used for resource creation

  securityContext:
    fsGroup: 26
  containerSecurityContext:
    runAsUser: 26
    runAsNonRoot: true
    capabilities:
      drop:
        - ALL
  #permissions for initContainers
  volumePermissions:
    enabled: false
    securityContext:
      capabilities:
        drop:
          - ALL

  # Set the configs to allow listening and connecting from other pods
  postgresqlConfiguration: {"listen_addresses": "*"}
  pgHbaConfiguration: |-
    local all all md5
    host all all all md5
  connParams: ""
  sslMode: "disable"
database:
  # Name of an existing secret to pull credentials from, leave empty for chart created database
  # Must at minimum contain DB_CONNECTION_STRING
  secret: ""
  # Init container for DB readiness check
  readinessCheck:
    # Disable the default readiness check which uses a non-IB image
    disableDefault: true
    # Defaults to Ironbank postgres, can be changed for different DB types (MySQL)
    image: registry1.dso.mil/ironbank/opensource/postgres/postgresql:18.2
    # Defaults to a readiness check for postgres, can be changed for different DB types
    command:
      - /bin/sh
      - -c
      - until pg_isready --dbname="$DB_CONNECTION_CHECK_URL"; do echo waiting for database; sleep 5; done;
    # Pass in the credentials needed for the DB check
    env:
      - name: DB_CONNECTION_CHECK_URL
        valueFrom:
          secretKeyRef:
            key: DB_CONNECTION_CHECK_URL
            name: '{{ .Values.database.secret | default (printf "%s-dbcreds" (include "mattermost.fullname" .)) }}'

fileStore:
  # Name of an existing secret to pull credentials from, leave empty for chart created minio
  secret: ""
  # URL for existing file store, leave empty for chart created minio
  url: ""
  # Bucket for existing file store, leave empty for chart created minio
  bucket: ""
  # ARN  of an IAM role to use.  Populate this when using Iam Roles for Service Accounts (IRSA)
  roleARN: ""

elasticsearch:
  # NOTE: Elasticsearch settings can be defined, but will not work unless enterprise mode is enabled.
  enabled: false
  # The address of the Elasticsearch server, default is internal elasticsearch
  connectionurl: "https://logging-ek-es-http.logging.svc.cluster.local:9200"
  # if using BB elasticsearch leave user/pass blank
  username: ""
  password: ""
  # When true, indexing of new posts occurs automatically. Search queries will use database search until "Enable Elasticsearch for search queries" is enabled.
  enableindexing: true
  # Elasticsearch index prefix
  indexprefix: "mm-"
  # When true, Mattermost will not require the Elasticsearch certificate to be signed by a trusted Certificate Authority
  skiptlsverification: true
  # Frequency to index to elasticsearch
  bulkindexingtimewindowseconds: 3600
  # When true, sniffing finds and connects to all data nodes in your cluster automatically.
  sniff: false
  # When true, Elasticsearch will be used for all search queries using the latest index. Search results may be incomplete until a bulk index of the existing post database is finished. When false, database search is used.
  enablesearching: true
  # When true, Elasticsearch will be used for all autocompletion queries on users and channels using the latest index. Autocompletion results may be incomplete until a bulk index of the existing users and channels database is finished. When false, database autocomplete is used.
  enableautocomplete: true

openshift: false

# Custom patch on the Mattermost resources before applying
resourcePatch: {}
# Example: Patch a label onto the deployment:
  # deployment:
  #   patch: '[{"op":"add","path":"/spec/template/spec/metadata/labels","value":{"istio-version": "1.2.3"}}]'

bbtests:
  enabled: false
  cypress:
    artifacts: true
    envs:
      cypress_url: http://mattermost.mattermost.svc.cluster.local:8065
      cypress_mm_email: "test@bigbang.dev"
      cypress_mm_user: "bigbang"
      cypress_mm_password: "Bigbang#123"
      cypress_waittime: "5000"
      cypress_tnr_username: "cypress"
      cypress_tnr_password: "tnr_w!G33ZyAt@C8"
    resources:
      requests:
        cpu: "2"
        memory: "1500M"
      limits:
        cpu: "2"
        memory: "1500M"

waitJob:
  enabled: true
  permissions:
    apiGroups: 
      - installation.mattermost.com
    resources:
      - mattermosts
